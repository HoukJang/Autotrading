# 실패 테스트 상세 분석 리포트

**작성일**: 2025-10-07
**대상**: Autotrading 프로젝트 실패 테스트 17개
**목적**: 실패 원인 분석 및 해결 방안 제시

---

## 1. 실패 테스트 요약

### 1.1 전체 현황
- **총 실패**: 17/58 테스트 (29%)
- **Mock 문제**: 14개 (82%)
- **코드 문제**: 1개 (6%)
- **테스트 코드 문제**: 2개 (12%)

### 1.2 카테고리별 분류
| 카테고리 | 실패 개수 | 주요 원인 |
|----------|-----------|-----------|
| Connection Manager | 2 | Mock 설정 오류 |
| IB Client | 9 | Mock 연결 미구현 |
| Edge Cases | 5 | Mock API 미구현 |
| Integration | 1 | Mock 종합 문제 |

---

## 2. Connection Manager 실패 (2개)

### 2.1 test_health_check_mechanism
**파일**: tests/test_phase2_ib.py:122
**상태**: 실패
**우선순위**: P2 (중간)

#### 실패 로그
```
assert is_healthy
E   assert False
```

#### 실패 원인 분석
1. **직접 원인**: Mock IB 객체 속성 설정 불일치
   ```python
   # 테스트 코드
   connection_manager._ib = mock_ib  # 직접 할당

   # 실제 코드
   if not self.ib or not self.ib.isConnected():  # property 접근
   ```

2. **근본 원인**:
   - _ib (private) vs ib (property) 접근 방식 차이
   - Mock 설정이 property를 고려하지 않음

3. **영향 범위**:
   - Mock 테스트만 영향
   - 실제 코드는 정상
   - Paper Trading 환경에서는 정상 작동 예상

#### 해결 방안

**방안 1: 테스트 코드 수정 (권장)**
```python
# 수정 전
connection_manager._ib = mock_ib

# 수정 후
connection_manager.ib = mock_ib  # property 사용
# 또는
with patch.object(connection_manager, 'ib', mock_ib):
    is_healthy = await connection_manager.health_check()
```

**방안 2: Paper Trading 테스트로 대체**
- 실제 IB Gateway 연결로 테스트
- Mock 문제 회피
- 실제 동작 검증

**권장 조치**:
- 단기: 테스트 코드 수정
- 장기: Paper Trading 환경 테스트 추가

---

### 2.2 test_graceful_disconnect
**파일**: tests/test_phase2_ib.py:217
**상태**: 실패
**우선순위**: P2 (중간)

#### 실패 로그
```
connection_manager._health_check_task.cancel.assert_called()
E   AttributeError: 'NoneType' object has no attribute 'cancel'
```

#### 실패 원인 분석
1. **직접 원인**: _health_check_task가 None 상태
   - connect() 호출 없이 disconnect() 테스트
   - health_check_task가 생성되지 않음

2. **테스트 시나리오 문제**:
   ```python
   # 연결 없이 바로 disconnect 호출
   await connection_manager.disconnect()
   # _health_check_task가 None이므로 cancel() 호출 불가
   ```

3. **영향 범위**:
   - 테스트 순서 문제
   - 실제 코드는 정상 (if _health_check_task: 체크)

#### 해결 방안

**방안 1: 테스트 시나리오 수정 (권장)**
```python
# 수정 전
async def test_graceful_disconnect(self, connection_manager):
    await connection_manager.disconnect()
    connection_manager._health_check_task.cancel.assert_called()

# 수정 후
async def test_graceful_disconnect(self, connection_manager, mock_ib):
    # 먼저 연결
    with patch('broker.connection_manager.IB', return_value=mock_ib):
        mock_ib.connectAsync = AsyncMock(return_value=None)
        mock_ib.isConnected = Mock(return_value=True)
        await connection_manager.connect()

    # health_check_task Mock 생성
    connection_manager._health_check_task = Mock()

    # disconnect 테스트
    await connection_manager.disconnect()
    connection_manager._health_check_task.cancel.assert_called()
```

**방안 2: None 체크 추가**
```python
# 테스트 코드
if connection_manager._health_check_task:
    connection_manager._health_check_task.cancel.assert_called()
```

**권장 조치**:
- 테스트 시나리오 수정 (연결 → 해제 순서)
- None 체크 추가로 안전성 향상

---

## 3. IB Client 실패 (9개)

### 3.1 공통 실패 패턴

#### 3.1.1 "Not connected to IB API" (6개)
**테스트**:
- test_market_data_subscription
- test_historical_data_request
- test_market_order_execution
- test_limit_order_execution
- test_bracket_order_execution
- test_error_scenarios

#### 공통 원인 분석
1. **연결 체크 로직**:
   ```python
   # ib_client.py
   if not self.connection_manager.is_connected():
       raise ConnectionError("Not connected to IB API")
   ```

2. **Mock 문제**:
   - Mock IB의 isConnected()가 True 반환
   - 하지만 connection_manager.ib가 None
   - 실제 연결 상태가 아님

3. **테스트 설정 부족**:
   ```python
   # Mock 설정 부족
   mock_ib.isConnected = Mock(return_value=True)
   # 하지만 실제 IB 객체가 할당되지 않음
   ```

#### 통합 해결 방안

**방안 1: Mock 설정 개선**
```python
# conftest.py 또는 테스트 픽스처
@pytest.fixture
async def connected_ib_client(ib_client, mock_ib):
    # Mock 연결 설정
    with patch('broker.connection_manager.IB', return_value=mock_ib):
        mock_ib.connectAsync = AsyncMock(return_value=None)
        mock_ib.isConnected = Mock(return_value=True)

        # 실제 연결
        await ib_client.connection_manager.connect()

        # IB 객체 할당 확인
        ib_client.connection_manager.ib = mock_ib

        yield ib_client

        # 정리
        await ib_client.connection_manager.disconnect()
```

**방안 2: Paper Trading 테스트 (강력 권장)**
- IB Gateway Paper Trading 사용
- 실제 연결 상태 검증
- Mock 문제 완전 회피

---

### 3.2 개별 테스트 분석

#### 3.2.1 test_market_data_subscription
**파일**: tests/test_phase2_ib.py:402
**원인**: 연결 체크 실패
**해결**: connected_ib_client fixture 사용

#### 3.2.2 test_historical_data_request
**파일**: tests/test_phase2_ib.py:451
**원인**: ConnectionError
**추가 문제**: reqHistoricalDataAsync Mock 미구현
**해결**:
1. 연결 설정
2. Mock API 추가:
   ```python
   mock_ib.reqHistoricalDataAsync = AsyncMock(return_value=[
       Mock(date=datetime.now(), open=4500, high=4510, low=4495, close=4505, volume=1000)
   ])
   ```

#### 3.2.3 test_market_order_execution
**파일**: tests/test_phase2_ib.py:463
**원인**: ExecutionError - "Not connected to IB API"
**추가 문제**: qualifyContractsAsync 미구현
**해결**:
```python
mock_ib.qualifyContractsAsync = AsyncMock(return_value=[mock_contract])
mock_ib.placeOrder = Mock(return_value=mock_trade)
```

#### 3.2.4 test_limit_order_execution
**파일**: tests/test_phase2_ib.py:476
**원인**: 동일 (market_order와 같음)
**해결**: 동일

#### 3.2.5 test_bracket_order_execution
**파일**: tests/test_phase2_ib.py:494
**원인**: 동일
**추가 복잡도**: 3개 주문 (entry, profit, stop)
**해결**:
```python
mock_bracket = Mock()
mock_bracket.entry = mock_trade
mock_bracket.takeProfit = mock_trade
mock_bracket.stopLoss = mock_trade
mock_ib.placeOrder = Mock(return_value=mock_bracket)
```

#### 3.2.6 test_order_cancellation
**파일**: tests/test_phase2_ib.py:515
**원인**: 연결 체크 + cancelOrder Mock 부족
**해결**:
```python
mock_ib.cancelOrder = AsyncMock(return_value=None)
```

#### 3.2.7 test_position_retrieval
**파일**: tests/test_phase2_ib.py:534
**원인**: 빈 리스트 반환 (positions Mock 부족)
**로그**: `assert len(positions) == 1` → `assert 0 == 1`
**해결**:
```python
mock_position = Mock()
mock_position.contract.symbol = 'ES'
mock_position.position = 2
mock_position.avgCost = 4500.00
mock_ib.positions = Mock(return_value=[mock_position])
```

#### 3.2.8 test_account_summary
**파일**: tests/test_phase2_ib.py:554
**원인**: KeyError: 'net_liquidation'
**문제**: accountSummary Mock 반환값 형식 불일치
**해결**:
```python
mock_summary = Mock()
mock_summary.tag = 'NetLiquidation'
mock_summary.value = '100000.00'
mock_ib.accountSummary = Mock(return_value=[mock_summary])
```

#### 3.2.9 test_error_scenarios
**파일**: tests/test_phase2_ib.py:586
**원인**: ConnectionError (연결 체크)
**해결**: connected_ib_client fixture 사용

---

## 4. Edge Cases 실패 (5개)

### 4.1 test_massive_subscription_management
**파일**: tests/test_edge_cases.py:368
**상태**: 실패
**우선순위**: P3 (낮음)

#### 실패 로그
```
assert all(result is True for result in results)
E   assert False
ERROR: Failed to subscribe to TEST0: Unknown futures symbol: TEST0
```

#### 실패 원인 분석
1. **직접 원인**: 테스트 심볼(TEST0-TEST99)이 Contract Factory에 미등록
   ```python
   # 테스트 코드
   symbols = [f"TEST{i}" for i in range(100)]

   # Contract Factory
   FUTURES_SPECS = {
       'ES': {...},
       'NQ': {...},
       # TEST0-TEST99 없음
   }
   ```

2. **근본 원인**: 테스트 전용 심볼 미지원

#### 해결 방안

**방안 1: Mock Contract Factory 확장 (권장)**
```python
# tests/mocks/ib_mocks.py
class MockContractFactory:
    @staticmethod
    def create_futures_contract(symbol, **kwargs):
        # 테스트 심볼 지원
        if symbol.startswith('TEST'):
            return Mock(
                symbol=symbol,
                secType='FUT',
                exchange='CME',
                currency='USD'
            )
        # 실제 심볼 처리
        return ContractFactory.create_futures_contract(symbol, **kwargs)
```

**방안 2: 실제 심볼 사용**
```python
# 테스트 코드 수정
symbols = ['ES', 'NQ', 'YM', 'RTY', 'GC']  # 실제 심볼
# 100개 대신 5개로 축소
```

**권장 조치**: Mock Contract Factory 확장

---

### 4.2 test_margin_calculation_edge_cases
**파일**: tests/test_edge_cases.py:
**상태**: 실패
**우선순위**: P1 (높음)

#### 실패 로그
```
(로그 상세 필요)
```

#### 실패 원인 분석
1. **예상 원인**: 극단적 레버리지 계산 검증 실패
   - 매우 높은 레버리지 (100x 이상)
   - 매우 낮은 레버리지 (1x 이하)
   - Margin 계산 로직 정확성 문제 가능

2. **검증 필요**:
   - Margin 계산 알고리즘
   - 극단값 처리 로직
   - 오버플로우/언더플로우 처리

#### 해결 방안

**방안 1: Margin 계산 로직 검증**
```python
# contracts.py - margin_requirement 메서드
def calculate_margin(self, leverage, position_value):
    # 극단값 체크 추가
    if leverage <= 0:
        raise ValueError("Leverage must be positive")
    if leverage > 100:
        logger.warning(f"Very high leverage: {leverage}x")

    margin = position_value / leverage

    # 최소 margin 보장
    min_margin = position_value * 0.01  # 1%
    return max(margin, min_margin)
```

**방안 2: 테스트 케이스 검토**
- 극단값 범위 재검토
- 예상 결과 재계산
- 허용 오차 범위 조정

**권장 조치**:
1. 실패 로그 상세 확인
2. Margin 계산 로직 검증
3. 테스트 케이스 재검토

---

### 4.3 test_concurrent_order_management
**파일**: tests/test_edge_cases.py:
**상태**: 실패
**우선순위**: P2 (중간)

#### 실패 원인
- qualifyContractsAsync Mock 미구현
- 동시 주문 실행 시뮬레이션 부족

#### 해결 방안
```python
# Mock IB 객체 개선
mock_ib.qualifyContractsAsync = AsyncMock(side_effect=lambda x: x)
mock_ib.placeOrder = Mock(side_effect=lambda contract, order: Mock(orderId=random.randint(1, 10000)))
```

---

### 4.4 test_event_bus_under_load
**파일**: tests/test_edge_cases.py:
**상태**: 실패
**우선순위**: P2 (중간)

#### 실패 원인
- Event Bus 고부하 시뮬레이션 실패
- 비동기 이벤트 처리 순서 문제 가능

#### 해결 방안
```python
# 테스트 코드 개선
async def test_event_bus_under_load(self, event_bus):
    received_events = []

    async def handler(event):
        await asyncio.sleep(0.001)  # 처리 시간 시뮬레이션
        received_events.append(event)

    event_bus.subscribe(EventType.MARKET, handler)

    # 대량 이벤트 발행
    events = [MarketBar(...) for _ in range(1000)]
    for event in events:
        await event_bus.publish(event)

    # 모든 이벤트 처리 대기
    await asyncio.sleep(2.0)

    assert len(received_events) == 1000
```

---

### 4.5 test_order_throughput
**파일**: tests/test_edge_cases.py:
**상태**: 실패
**우선순위**: P3 (낮음)

#### 실패 원인
- Mock 주문 실행이 즉시 완료 (지연 없음)
- 실제 처리량 측정 불가

#### 해결 방안
```python
# Mock 지연 추가
async def mock_place_order_with_delay(contract, order):
    await asyncio.sleep(0.01)  # 10ms 지연
    return Mock(orderId=random.randint(1, 10000))

mock_ib.placeOrder = mock_place_order_with_delay
```

---

## 5. Integration 실패 (1개)

### 5.1 test_complete_trading_workflow
**파일**: tests/test_phase2_ib.py:
**상태**: 실패
**우선순위**: P1 (높음)

#### 실패 원인
- 전체 워크플로우 테스트 (연결 → 데이터 → 주문 → 포지션)
- 여러 Mock 문제 복합

#### 해결 방안
**Paper Trading 전환 강력 권장**
- 통합 테스트는 실제 환경에서 검증 필요
- Mock으로는 전체 워크플로우 시뮬레이션 한계

---

## 6. 해결 우선순위 및 계획

### 6.1 우선순위 매트릭스
| 우선순위 | 테스트 | 원인 | 영향 | 해결 방안 |
|---------|--------|------|------|-----------|
| P0 | Paper Trading 전환 | Mock 한계 | 높음 | 실제 환경 테스트 |
| P1 | test_margin_calculation | 코드 문제 가능 | 중간 | 로직 검증 |
| P1 | test_complete_trading_workflow | 통합 문제 | 높음 | Paper Trading |
| P2 | Connection Manager (2개) | Mock 설정 | 낮음 | 테스트 수정 |
| P2 | IB Client (9개) | Mock 연결 | 중간 | Mock 개선 |
| P3 | Edge Cases (3개) | Mock API | 낮음 | Mock 확장 |

### 6.2 단계별 해결 계획

#### Phase 1: 즉시 실행 (1주)
1. **Paper Trading 환경 전환**
   - IB Gateway Paper Trading 실행
   - 실제 연결 테스트
   - 목표: IB Client 9개 테스트 통과

2. **Margin 계산 검증**
   - 로그 상세 확인
   - 계산 로직 검토
   - 테스트 케이스 수정

#### Phase 2: 단기 개선 (2주)
1. **Mock 설정 개선**
   - Connection Manager 2개 수정
   - connected_ib_client fixture 작성
   - 테스트 코드 리팩토링

2. **Mock API 확장**
   - qualifyContractsAsync 구현
   - reqCurrentTimeAsync 개선
   - positions/accountSummary Mock 추가

#### Phase 3: 중기 개선 (1개월)
1. **Mock Contract Factory 확장**
   - 테스트 심볼 지원
   - 대량 subscription 테스트

2. **성능 테스트 개선**
   - 지연 시뮬레이션
   - 처리량 측정 로직
   - Event Bus 부하 테스트

---

## 7. Mock vs Paper Trading 전환 가이드

### 7.1 전환이 필요한 테스트
| 테스트 | Mock | Paper | 권장 |
|--------|------|-------|------|
| IB Client (9개) | 실패 | 통과 예상 | Paper |
| test_complete_trading_workflow | 실패 | 통과 예상 | Paper |
| test_order_throughput | 제한적 | 정확 | Paper |
| Connection Manager (2개) | 수정 가능 | 통과 | Mock |
| Edge Cases (5개) | 개선 가능 | 통과 | Mock |

### 7.2 Paper Trading 전환 절차
1. **IB Gateway 설정**
   - Paper Trading 계정 로그인
   - 포트 4002 확인
   - API 연결 허용

2. **테스트 실행**
   ```bash
   # 실제 연결 필요 테스트만
   pytest tests/test_phase2_ib.py::TestIBClient -v --with-tws

   # 전체 통합 테스트
   pytest tests/test_phase2_ib.py::TestIntegrationScenarios -v --with-tws
   ```

3. **결과 검증**
   - 연결 성공 확인
   - 주문 실행 확인
   - 데이터 수신 확인

---

## 8. 결론

### 8.1 핵심 발견
1. **Mock 문제가 대부분**: 17개 중 14개 (82%)
2. **실제 코드 문제 최소**: 1개 (6%)
3. **Paper Trading 전환 필요**: IB Client 전체

### 8.2 권장 조치
1. **즉시**: Paper Trading 환경 전환
2. **단기**: Mock 설정 개선
3. **중기**: Mock API 확장
4. **장기**: 실제 환경 통합 테스트

### 8.3 예상 효과
- **Mock 개선**: 41/58 → 45/58 (78%)
- **Paper Trading 전환**: 41/58 → 52/58 (90%)
- **종합 개선**: 최대 95%+ 통과율 달성 가능

---

## 부록: 빠른 수정 스크립트

### A. connected_ib_client Fixture
```python
# conftest.py에 추가
@pytest.fixture
async def connected_ib_client(ib_client, mock_ib):
    """완전히 연결된 IB Client fixture"""
    with patch('broker.connection_manager.IB', return_value=mock_ib):
        # Mock 설정
        mock_ib.connectAsync = AsyncMock(return_value=None)
        mock_ib.isConnected = Mock(return_value=True)
        mock_ib.qualifyContractsAsync = AsyncMock(side_effect=lambda x: x)
        mock_ib.reqCurrentTimeAsync = AsyncMock(return_value=datetime.now())

        # 연결
        await ib_client.connection_manager.connect()
        ib_client.connection_manager.ib = mock_ib

        yield ib_client

        # 정리
        await ib_client.connection_manager.disconnect()
```

### B. Mock IB 확장
```python
# tests/mocks/ib_mocks.py
class EnhancedMockIB(MockIB):
    """개선된 Mock IB 객체"""

    def __init__(self):
        super().__init__()
        self.qualifyContractsAsync = AsyncMock(side_effect=lambda x: x)
        self.reqCurrentTimeAsync = AsyncMock(return_value=datetime.now())
        self.reqHistoricalDataAsync = AsyncMock(return_value=[])
        self.placeOrder = Mock(return_value=Mock(orderId=1))
        self.cancelOrder = AsyncMock(return_value=None)
        self.positions = Mock(return_value=[])
        self.accountSummary = Mock(return_value=[])
```

### C. Paper Trading 테스트 실행
```bash
# 단일 테스트
pytest tests/test_phase2_ib.py::TestIBClient::test_market_order_execution -v --with-tws

# 전체 IB Client
pytest tests/test_phase2_ib.py::TestIBClient -v --with-tws

# 통합 테스트
pytest tests/test_phase2_ib.py::TestIntegrationScenarios -v --with-tws
```
